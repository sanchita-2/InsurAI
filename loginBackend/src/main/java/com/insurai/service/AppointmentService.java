package com.insurai.service; import com.insurai.dto.AppointmentDto; import com.insurai.entity.Appointment; import com.insurai.entity.User; import com.insurai.mapper.AppointmentMapper; import com.insurai.repository.AppointmentRepository; import com.insurai.repository.UserRepository; import org.springframework.stereotype.Service; import java.time.LocalDateTime; import java.util.List; import java.util.stream.Collectors; @Service public class AppointmentService { private final AppointmentRepository repo; private final UserRepository userRepo; private final AppointmentMapper mapper; private final com.insurai.service.NotificationService notificationService; public AppointmentService(AppointmentRepository repo, UserRepository userRepo, AppointmentMapper mapper, com.insurai.service.NotificationService notificationService){ this.repo=repo; this.userRepo=userRepo; this.mapper=mapper; this.notificationService=notificationService; } public AppointmentDto createAppointment(AppointmentDto dto){ User user = userRepo.findById(dto.getUserId()).orElseThrow(()->new RuntimeException("User not found")); User agent = userRepo.findById(dto.getAgentId()).orElseThrow(()->new RuntimeException("Agent not found")); if(!"AGENT".equalsIgnoreCase(agent.getRole()) || agent.getApproved()==null || agent.getApproved()!=1) throw new RuntimeException("Agent not approved"); Appointment a=new Appointment(); a.setUser(user); a.setAgent(agent); a.setMessage(dto.getMessage()); a.setAppointmentTime(dto.getAppointmentTime()==null?LocalDateTime.now().plusDays(1):dto.getAppointmentTime()); a.setStatus("PENDING"); Appointment saved = repo.save(a); notificationService.create(saved.getUser().getId(), saved.getAgent().getId(), "Appointment booked", "Your appointment has been created."); notificationService.create(null, saved.getAgent().getId(), "New appointment", "A user booked an appointment."); return mapper.toDto(saved); } public List<AppointmentDto> getAppointmentsByUser(Long userId){ return repo.findByUserId(userId).stream().map(mapper::toDto).collect(Collectors.toList()); } public List<AppointmentDto> getAppointmentsByAgent(Long agentId){ return repo.findByAgentId(agentId).stream().map(mapper::toDto).collect(Collectors.toList()); } public List<AppointmentDto> getAllAppointments(){ return repo.findAll().stream().map(mapper::toDto).collect(Collectors.toList()); } public AppointmentDto updateStatus(Long appointmentId, String status){ Appointment a = repo.findById(appointmentId).orElseThrow(()->new RuntimeException("Appointment not found")); a.setStatus(status); Appointment updated = repo.save(a); notificationService.create(updated.getUser().getId(), updated.getAgent().getId(), "Appointment " + status, "Your appointment was " + status.toLowerCase()); return mapper.toDto(updated); } }
